<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversational Voice Agent</title>
</head>
<body>
  <h1>ðŸŽ¤ Conversational Voice Agent</h1>

  <button id="recordBtn">Start Recording</button>
  <p id="status">Click "Start Recording" to speak</p>

  <h3>Transcription:</h3>
  <pre id="transcription"></pre>

  <h3>Response:</h3>
  <pre id="response"></pre>

  <audio id="audioReply" controls></audio>

<script>
  const recordBtn = document.getElementById("recordBtn");
  const statusEl = document.getElementById("status");
  const transcriptionEl = document.getElementById("transcription");
  const responseEl = document.getElementById("response");
  const audioReplyEl = document.getElementById("audioReply");

  let mediaRecorder;
  let audioChunks = [];

  recordBtn.onclick = async () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      recordBtn.disabled = true;
      statusEl.textContent = "Processing audio...";
    } else {
      transcriptionEl.textContent = "";
      responseEl.textContent = "";
      audioReplyEl.src = "";
      audioReplyEl.style.display = "none";

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => {
        audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        audioChunks = [];

        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.wav");

        try {
          const res = await fetch("/chat", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            throw new Error("Server error");
          }

          const data = await res.json();

          transcriptionEl.textContent = data.transcription;
          responseEl.textContent = data.response;

          if (data.audio_reply_url) {
            audioReplyEl.src = data.audio_reply_url;
            audioReplyEl.style.display = "block";
            audioReplyEl.play();
          }
        } catch (err) {
          statusEl.textContent = "Error: " + err.message;
        } finally {
          recordBtn.disabled = false;
          statusEl.textContent = "Click 'Start Recording' to speak";
        }
      };

      audioChunks = [];
      mediaRecorder.start();
      statusEl.textContent = "Recording... Click again to stop.";
      recordBtn.textContent = "Stop Recording";
    }
  };
</script>
</body>
</html>
